import{M as H,p as l,R as J,D as Q,H as u,C as k,b as m,h as t,P as h,y as _,G as x,a2 as K,t as g,e as W,F as X,i as Y,k as Z,v as aa,l as ea,o as p,Q as oa,I as ta}from"./app-BArZ-JoB.js";import{u as na}from"./albumesAdmin-wFGr6eia.js";const ra={class:""},sa={class:""},ia={class:"row mb-4"},la={class:"col-12 text-center mb-6"},ca={class:"imagen_album",style:{width:"200px",height:"200px"}},da=["src"],ua={class:"col-md-6"},ma={class:"form-group mb-3"},pa={class:"col-md-6"},va={class:"form-group mb-3"},ba={class:"col-12"},fa={class:"album_info mt-2"},ha={class:"row mb-3"},ga={class:"col-12"},ya={class:"lista_canciones"},_a={key:0,class:"text-center py-3 text-muted"},wa={class:"numero_cancion me-2"},Ca=["onUpdate:modelValue"],Ea={class:"duracion_cancion me-2"},$a=["onClick"],ka={class:"row mb-4"},xa={class:"col-12"},Da={class:"d-flex justify-content-between"},ja=["disabled"],Na={key:1,class:"text-center p-5"},Ra={key:2,class:"alert alert-danger"},Fa={__name:"Edit",setup(Ua){const d=H(),D=ta(),j=ea();na();const v=j.params.id,b=l(null),w=l(!1),c=l(!0),N=l(null),R=l(null),f=l(null),r=l([]),C=l([]),E=l([]),y=l(!1),i=J({nombre:"",tipo:"album",portada:null,num_canciones:0,duracion_total:"0:00"});Q(async()=>{try{c.value=!0;const e=await u.get(`/api/admin/albumes/${v}`);if(!e.data||!e.data.data)throw new Error("Datos de álbum no encontrados");const a=e.data.data;b.value=a,i.nombre=a.nombre,i.tipo=a.tipo||"album",a.portada&&(b.value.portada_url=a.portada);const o=await u.get(`/api/albumes/${v}/canciones`);if(o.data&&o.data.data){const n=o.data.data;r.value=n.map(s=>({id:s.id,nombre:s.nombre,duracion:s.duracion||"0:00",archivo:null,esExistente:!0})),C.value=JSON.parse(JSON.stringify(r.value))}w.value=!0,c.value=!1}catch(e){console.error("Error al cargar datos del álbum:",e),c.value=!1,d.add({severity:"error",summary:"Error de carga",detail:"No se pudo cargar la información del álbum",life:3e3})}});const U=e=>new Promise(a=>{const o=new Audio,n=URL.createObjectURL(e);o.src=n,o.addEventListener("loadedmetadata",()=>{const s=Math.floor(o.duration),B=Math.floor(s/60),G=s%60;URL.revokeObjectURL(n),o.remove(),a(`${B}:${G.toString().padStart(2,"0")}`)}),o.addEventListener("error",()=>{URL.revokeObjectURL(n),o.remove(),a("0:00")})}),L=e=>{const a=e.target.files[0];a&&(f.value&&URL.revokeObjectURL(f.value),i.portada=a,f.value=URL.createObjectURL(a),y.value=!0,d.add({severity:"info",summary:"Portada seleccionada",detail:"Nueva imagen de portada añadida",life:3e3}))},S=async e=>{const a=Array.from(e.target.files);if(a.length!==0){for(const o of a){const n=await U(o);r.value.push({nombre:o.name.replace(/\.[^/.]+$/,""),archivo:o,duracion:n,esExistente:!1})}d.add({severity:"success",summary:"Canciones añadidas",detail:`${a.length} canción(es) agregadas`,life:3e3}),e.target.value=""}},F=e=>{const a=r.value[e];a.id&&a.esExistente&&E.value.push(a.id),r.value.splice(e,1),d.add({severity:"success",summary:"Canción eliminada",detail:"La canción fue removida del álbum",life:3e3})},A=()=>r.value.reduce((e,a)=>{if(!a.duracion)return e;const o=a.duracion.split(":").map(Number),n=o[0]||0,s=o[1]||0;return e+n*60+s},0),M=e=>{const a=Math.floor(e/60),o=e%60;return`${a}:${o.toString().padStart(2,"0")}`},$=k(()=>M(A())),O=k(()=>i.nombre&&r.value.length>0&&r.value.every(e=>e.nombre)),I=()=>{let e=[];if(i.nombre||e.push({campo:"nombre",mensaje:"Falta añadir el nombre del álbum"}),r.value.length===0)e.push({campo:"canciones",mensaje:"Debe haber al menos una canción"});else{const a=r.value.filter(o=>!o.nombre);a.length>0&&e.push({campo:"nombreCanciones",mensaje:`${a.length} canción(es) sin nombre`})}return e},T=async()=>{const e=r.value.filter(a=>a.esExistente&&a.id);for(const a of e){const o=C.value.find(n=>n.id===a.id);if(o&&o.nombre!==a.nombre)try{await u.put(`/api/canciones/${a.id}`,{nombre:a.nombre,duracion:a.duracion})}catch(n){throw console.error(`Error al actualizar canción ${a.id}:`,n),n}}},V=async()=>{for(const e of E.value)try{await u.delete(`/api/canciones/${e}`)}catch(a){throw console.error(`Error al eliminar canción ${e}:`,a),a}},z=async()=>{const e=r.value.filter(a=>!a.esExistente);for(let a=0;a<e.length;a++){const o=e[a],n=new FormData;n.append("nombre",o.nombre),n.append("duracion",o.duracion),n.append("archivo",o.archivo),n.append("album_id",v),n.append("orden",(r.value.indexOf(o)+1).toString());try{await u.post("/api/canciones",n,{headers:{"Content-Type":"multipart/form-data"}})}catch(s){throw console.error("Error al subir nueva canción:",s),s}}},P=async()=>{if(y.value&&i.portada)try{const e=new FormData;e.append("portada",i.portada),await u.post(`/api/albumes/${v}/portada`,e,{headers:{"Content-Type":"multipart/form-data"}})}catch(e){throw console.error("Error al actualizar portada:",e),e}},q=async()=>{var a;const e=I();if(e.length>0){e.forEach(o=>{d.add({severity:"error",summary:"Error de validación",detail:o.mensaje,life:3e3})});return}try{c.value=!0;const o={nombre:i.nombre,tipo:i.tipo,num_canciones:r.value.length.toString(),duracion_total:$.value};await u.put(`/api/albumes/${v}`,o),y.value&&await P(),await T(),await V(),await z(),c.value=!1,d.add({severity:"success",summary:"Álbum actualizado",detail:"El álbum se ha actualizado exitosamente",life:3e3}),D.push("/admin/albumes")}catch(o){c.value=!1,console.error("Error general:",(a=o.response)==null?void 0:a.data),d.add({severity:"error",summary:"Error al guardar",detail:"Ha ocurrido un error al actualizar el álbum",life:3e3})}};return(e,a)=>(p(),m("div",ra,[a[10]||(a[10]=t("div",{class:""},[t("h2",{class:""},"Editar Álbum")],-1)),t("div",sa,[!c.value&&w.value?(p(),m("form",{key:0,onSubmit:h(q,["prevent"]),class:"formulario_album"},[t("div",ia,[t("div",la,[t("div",ca,[t("img",{src:f.value||b.value&&b.value.portada_url||"/images/placeholder1.jpg",class:"",style:{width:"100%",height:"100%","object-fit":"cover"}},null,8,da),t("input",{type:"file",onChange:L,accept:"image/*",ref_key:"archivoImagen",ref:N,class:"d-none"},null,544),t("button",{onClick:a[0]||(a[0]=h(o=>e.$refs.archivoImagen.click(),["prevent"])),class:"btn btn-outline-primary mt-2"}," Cambiar Portada ")])]),t("div",ua,[t("div",ma,[a[5]||(a[5]=t("label",{for:"nombre"},"Nombre del álbum*",-1)),_(t("input",{type:"text",id:"nombre","onUpdate:modelValue":a[1]||(a[1]=o=>i.nombre=o),class:"form-control",placeholder:"Nombre del álbum",maxlength:"100",required:""},null,512),[[x,i.nombre]])])]),t("div",pa,[t("div",va,[a[7]||(a[7]=t("label",{for:"tipo"},"Tipo*",-1)),_(t("select",{id:"tipo","onUpdate:modelValue":a[2]||(a[2]=o=>i.tipo=o),class:"form-select",required:""},a[6]||(a[6]=[t("option",{value:"album"},"Álbum",-1),t("option",{value:"sencillo"},"Sencillo",-1),t("option",{value:"ep"},"EP",-1)]),512),[[K,i.tipo]])])]),t("div",ba,[t("div",fa,[t("p",null,"Número de canciones: "+g(r.value.length),1),t("p",null,"Duración total: "+g($.value),1)])])]),t("div",ha,[t("div",ga,[a[8]||(a[8]=t("h4",null,"Canciones",-1)),t("div",ya,[r.value.length===0?(p(),m("div",_a," No hay canciones añadidas ")):W("",!0),(p(!0),m(X,null,Y(r.value,(o,n)=>(p(),m("div",{key:o.id||n,class:"cancion border-bottom py-2 d-flex align-items-center"},[t("span",wa,g(n+1),1),_(t("input",{"onUpdate:modelValue":s=>o.nombre=s,placeholder:"Nombre de la canción",class:"form-control me-2",maxlength:"45"},null,8,Ca),[[x,o.nombre]]),t("span",Ea,g(o.duracion||"0:00"),1),t("button",{onClick:h(s=>F(n),["prevent"]),class:"btn btn-sm btn-danger"},"⨯",8,$a)]))),128))])])]),t("div",ka,[t("div",xa,[t("input",{type:"file",ref_key:"archivoAudio",ref:R,onChange:S,accept:"audio/*",class:"d-none",multiple:""},null,544),t("button",{onClick:a[3]||(a[3]=h(o=>e.$refs.archivoAudio.click(),["prevent"])),class:"btn btn-primary"}," Añadir canción ")])]),t("div",Da,[t("button",{type:"button",class:"btn btn-secondary",onClick:a[4]||(a[4]=o=>e.$router.push("/admin/albumes"))}," Cancelar "),t("button",{type:"submit",class:"btn btn-success",disabled:!O.value||c.value}," Guardar Cambios ",8,ja)]),Z(aa(oa))],32)):c.value?(p(),m("div",Na,a[9]||(a[9]=[t("div",{class:"spinner-border",role:"status"},[t("span",{class:"visually-hidden"},"Cargando...")],-1),t("p",{class:"mt-3"},"Cargando datos del álbum...",-1)]))):(p(),m("div",Ra," No se pudo cargar la información del álbum "))])]))}};export{Fa as default};
